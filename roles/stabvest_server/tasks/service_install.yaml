---
- name: Deploy Stabvest Worker Service
  copy:
    dest: /etc/systemd/system/stabvest-worker.service
    content: |
      [Unit]
      Description=Stabvest Background Worker
      After=network.target

      [Service]
      Type=notify
      User=root
      WorkingDirectory={{ stabvest_deploy_dir }}
      ExecStart={{ stabvest_deploy_dir }}/venv/bin/python3 worker.py
      Restart=always
      TimeoutStartSec=30

      [Install]
      WantedBy=multi-user.target

- name: Deploy Stabvest Gunicorn Service
  copy:
    dest: /etc/systemd/system/stabvest-server.service
    content: |
      [Unit]
      Description=Stabvest Gunicorn Server
      After=network.target stabvest-worker.service
      Requires=stabvest-worker.service

      [Service]
      User=root
      WorkingDirectory={{ stabvest_deploy_dir }}
      ExecStart={{ stabvest_deploy_dir }}/venv/bin/gunicorn \
        --certfile=cert.pem \
        --keyfile=key.pem \
        --workers {{ stabvest_gunicorn_workers }} \
        --bind 0.0.0.0:{{ stabvest_port }} \
        server:app
      Restart=always

      [Install]
      WantedBy=multi-user.target