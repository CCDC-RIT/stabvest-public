<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Agents Dashboard</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1a2b;
      --muted:#a0b0c0;
      --text:#ffffff;
      --accent:#4aa3ff;
      --accent-2:#2e6fb6;
      --row-hover:#0e2a45;
      --success:#3bd671;
      --danger:#ff6b6b;
      --border: rgba(255,255,255,0.04);
      --bool-dark:#888888;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg), #071020);color:var(--text)}
    .container{max-width:100%;margin:14px auto;padding:20px}

    header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    h1{margin:0;font-size:20px}
    p.lead{margin:0;color:var(--muted);font-size:13px}

    .card{background:var(--card);border-radius:12px;padding:14px;border:1px solid var(--border);box-shadow:0 6px 20px rgba(10,15,25,0.6)}

    /* AGGRESSIVE SHRINK: table set to 1px to force content-based collapse */
    table{width: 1px; min-width: 100%; border-collapse:collapse; font-size:13px; table-layout: fixed;}
    thead th{position:sticky;top:0;background:linear-gradient(180deg, rgba(12,20,30,0.95), rgba(12,20,30,0.9));backdrop-filter:blur(4px);z-index:2;padding:8px 10px;text-align:left;color:var(--muted);border-bottom:1px solid var(--border); white-space: nowrap; overflow: hidden;}
    thead th .col-head{display:flex;align-items:center;gap:8px; overflow: hidden;}
    
    .resizer {
      position: absolute;
      right: 0; top: 0;
      height: 100%; width: 5px;
      cursor: col-resize;
      z-index: 3;
    }
    .resizer:hover { background: var(--accent); }

    /* width: 1% forces the cell to shrink until it hits the content width */
    tbody td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.02);vertical-align:middle;color:var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 1%;}
    tbody tr:hover{background:var(--row-hover)}

    .btn{appearance:none;border:0;padding:8px 10px;border-radius:8px;background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#042033;font-weight:600;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)}
    .btn.muted{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.02);cursor:not-allowed;opacity:0.6}
    .btn.pause{background:linear-gradient(180deg,#ffb870,#ff9b3b);color:#1b0f00}
    .btn.resume{background:linear-gradient(180deg,#8ef0a1,#4bd071);color:#042033}

    .small{font-size:12px;color:var(--muted)}
    .false-red{color:var(--danger);font-weight:bold}
    .stale-true{color:var(--danger);font-weight:bold}
    .bool-dark{color:var(--bool-dark)}
    .col-filter input{width:100%;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.02);color:var(--text); box-sizing: border-box;}

    th.sortable{cursor:pointer}
    th.sortable .sort-ind{font-size:11px;color:var(--muted)}

    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,12,0.6);display:flex;align-items:center;justify-content:center;z-index:50}
    .modal{background:var(--card);padding:18px;border-radius:10px;width:380px;max-width:94%;box-shadow:0 10px 40px rgba(2,6,12,0.8);border:1px solid var(--border)}

    .toast{position:fixed;bottom:20px;right:20px;background:var(--accent);color:#042033;padding:12px 18px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.3);opacity:0;transition:opacity 0.3s ease;z-index:100}
    .toast.show{opacity:1;}

    .site-footer { background-color: #042033; text-align: center; padding: 15px 0; font-size: 0.9rem; color: #555; }
    .site-footer a { color: #007bff; text-decoration: none; font-weight: 500; }
    .header-container { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .header-icon { width: 40px; height: 40px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div style="display:flex;flex-direction:column">
        <div class="header-container">
          <img src="../static/favicon.ico" alt="RIT Tiger" class="header-icon">
          <h1>Agents Dashboard</h1>
          <a href="/">Back to Home</a>
        </div>
        <p class="lead">All agents recorded by the server. Times shown in your local timezone. Auto-refreshes every 60 seconds.</p>
        <p class="lead">Click column headers to sort. Type in the filters under headers to refine results per-column.</p>
      </div>
      <div style="margin-left:auto;display:flex;flex-direction:column;align-items:flex-end;gap:4px">
        <div style="display:flex;gap:8px;align-items:center">
          <button id="refreshBtn" class="btn ghost" title="Refresh list">Refresh</button>
          <button id="downloadBtn" class="btn" title="Download current table as JSON" hidden>Download JSON</button>
        </div>
        <span id="lastUpdate" style="font-size: 11px; color: var(--muted);">Updating...</span>
      </div>
    </header>

    <section class="card" id="mainCard">
      <div id="tableWrap" style="overflow:auto;max-height:90vh">
        <table id="agentsTable"></table>
      </div>
    </section>
  </div>

  <div id="pauseModal" class="modal-backdrop" style="display:none">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="pauseTitle">
      <h3 id="pauseTitle">Pause Agent</h3>
      <div class="field">
        <label class="small">Agent ID</label>
        <div id="modalAgentId" class="muted-pill" style="font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.02);color:var(--muted)"></div>
      </div>
      <div class="field" style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px">
        <label class="small">Pause duration (seconds)</label>
        <input id="pauseSeconds" type="number" min="1" value="60" />
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px">
        <button id="cancelPause" class="btn ghost">Cancel</button>
        <button id="confirmPause" class="btn pause">Pause</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">Agents data refreshed successfully</div>

  <footer class="site-footer">
    <p>Made by the <a href="https://github.com/CCDC-RIT" target="_blank" rel="noopener noreferrer">Rochester Institute of Technology Collegiate Cyber Defense Team</a></p>
  </footer>

  <script>
    const ENDPOINTS = { listAgents:'/list_agents', pause:'/agent_pause', resume:'/agent_resume' };
    let agentsData = {}, columns = [], filters = {}, sortState = {key:null, dir:1}, searchTimer;
    let columnWidths = {};

    const refreshBtn = document.getElementById('refreshBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const tableEl = document.getElementById('agentsTable');
    const modal = document.getElementById('pauseModal');
    const modalAgentId = document.getElementById('modalAgentId');
    const pauseSecondsInput = document.getElementById('pauseSeconds');
    const cancelPauseBtn = document.getElementById('cancelPause');
    const confirmPauseBtn = document.getElementById('confirmPause');
    const toastEl = document.getElementById('toast');
    const updateTimeEl = document.getElementById('lastUpdate');
    let activePauseAgent = null;

    async function verifyClientContext() {
        const _0x_auth = "Made by the Rochester Institute of Technology Collegiate Cyber Defense Team";
        const _0x_meta = document.querySelector('.site-footer');
        const _0x_img = document.querySelector('.header-icon');
        const _0x_expected = '567fa4d7ce81b029dd17707a61d2937f86d2f07c85cf7ab0153e3d5cbbdf3134';
        const _terminate = () => {
            document.body.innerHTML = `<div style="padding:50px; text-align:center; color:#ff6b6b; font-family:sans-serif;"><h2>Error integrity_failure</h2><p>Critical data corrupted.</p></div>`;
            throw new Error("Integrity violation");
        };
        if (!_0x_meta || !_0x_meta.innerText.includes(_0x_auth)) _terminate();
        if (!_0x_img) _terminate();
        if (!_0x_img.complete) await new Promise((r) => { _0x_img.onload = r; _0x_img.onerror = _terminate; });
        if (_0x_img.naturalWidth === 0) _terminate();
        try {
            const _canv = document.createElement('canvas'); const _ctx = _canv.getContext('2d');
            _canv.width = _0x_img.naturalWidth; _canv.height = _0x_img.naturalHeight;
            _ctx.drawImage(_0x_img, 0, 0);
            const _data = _ctx.getImageData(0, 0, _canv.width, _canv.height).data;
            const _buffer = await crypto.subtle.digest('SHA-256', _data);
            const _actual = Array.from(new Uint8Array(_buffer)).map(b => b.toString(16).padStart(2, '0')).join('');
            if (_actual !== _0x_expected) _terminate();
        } catch (e) { _terminate(); }
    }

    async function postJSON(url,payload){
      const res=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      if(!res.ok){const txt=await res.text();throw new Error(`HTTP ${res.status}: ${txt}`);}
      return res.headers.get('content-type')?.includes('application/json') ? res.json() : res.text();
    }

    function formatTime(epoch){
      //if(!epoch)return'0'; if(epoch === 1)return'1';
      if(!epoch || epoch === 0 || epoch === 1 || epoch === "0" || epoch === "1") return epoch;
      const e=Number(epoch); if(!e)return String(epoch);
      const date=(e>1e12)?new Date(e):new Date(e*1000);
      return date.toLocaleString();
    }

    function deriveColumns(data){
      const keys=new Set();
      for(const [id,rec] of Object.entries(data)){keys.add('agent_id');for(const k of Object.keys(rec))keys.add(k);break;}
      return Array.from(keys);
    }

    // AGGRESSIVE: Logic to shrink to exact content width
    function calculateIdealWidths(colKey = null) {
      const rows = Object.values(agentsData);
      const colKeys = colKey ? [colKey] : ['_actions', '_resume', ...columns];

      colKeys.forEach(k => {
        if (k === '_actions' || k === '_resume') { columnWidths[k] = 80; return; }
        
        let maxLength = k.length;
        
        if (k !== 'agent_id') {
          rows.forEach(rec => {
            let v = Object.assign({agent_id: Object.keys(agentsData).find(key => agentsData[key] === rec)}, rec)[k];
            if(/time|seen|until|timestamp/i.test(k) && v) v = formatTime(v);
            const len = String(v ?? '').length;
            if (len > maxLength) maxLength = len;
          });
          // Aggressive multiplier: 7.2px per character + tiny 10px buffer
          columnWidths[k] = Math.ceil(maxLength * 6.5) + 5;
        } else {
          // Exact fit for "agent_id" title
          columnWidths[k] = (k.length * 8); 
        }
      });
    }

    async function fetchAgents(){
      try{
        const res=await postJSON(ENDPOINTS.listAgents,{});
        agentsData=(typeof res==='object')?res:JSON.parse(res);
        await verifyClientContext();
        columns=deriveColumns(agentsData);
        if (Object.keys(columnWidths).length === 0) calculateIdealWidths();
        renderTable();
        showToast();
        updateTimeEl.innerText = "Updated: " + new Date().toLocaleTimeString();
      }catch(err){ if(err.message !== "Integrity violation") console.error(err); }
    }

    function showToast(){toastEl.classList.add('show');setTimeout(()=>toastEl.classList.remove('show'),3000);}

    function renderTable(){
      const colKeys=['_actions','_resume',...columns];
      let thead='<thead><tr>'+colKeys.map(k=>{
        const w = columnWidths[k] ? `style="width:${columnWidths[k]}px"` : '';
        if(k==='_actions')return`<th class="col-actions" ${w}>Actions<div class="resizer"></div></th>`; 
        if(k==='_resume')return`<th class="col-actions" ${w}>Resume<div class="resizer"></div></th>`; 
        const display=escapeHtml(k); 
        const sortMark=(sortState.key===k)?(sortState.dir===1?'▲':'▼'):''; 
        return`<th class="sortable" data-key="${display}" ${w}><div class="col-head"><span>${display}</span><span class="sort-ind">${sortMark}</span></div><div class="resizer"></div></th>`;
      }).join('')+'</tr><tr>';
      
      thead+=colKeys.map(k=>{if(k==='_actions'||k==='_resume')return`<th></th>`; const val=filters[k]||''; return `<th class="col-filter"><input data-col="${escapeHtml(k)}" placeholder="..." value="${escapeHtml(val)}" /></th>`;}).join('')+'</tr></thead>';

      const bodyRows=buildFilteredSortedRows();
      tableEl.innerHTML=thead+'<tbody>'+bodyRows.map(r=>r.html).join('')+'</tbody>';

      tableEl.querySelectorAll('th.sortable').forEach(th=>th.addEventListener('click',e=>{
        if(!e.target.classList.contains('resizer')) toggleSort(th.getAttribute('data-key'));
      }));
      tableEl.querySelectorAll('.col-filter input').forEach(inp=>inp.addEventListener('input',e=>{
          clearTimeout(searchTimer);
          searchTimer=setTimeout(()=>{ filters[e.target.getAttribute('data-col')]=e.target.value; renderTable(); },700);
      }));
      tableEl.querySelectorAll('button[data-action="pause"]').forEach(btn=>btn.addEventListener('click',()=>openPauseModal(btn.getAttribute('data-agent'))));
      tableEl.querySelectorAll('button[data-action="resume"]').forEach(btn=>btn.addEventListener('click',async()=>{
          const agentId=btn.getAttribute('data-agent');
          try{await postJSON(ENDPOINTS.resume,{agent_id:agentId});await fetchAgents();}catch(err){alert('Failed: '+err.message);}
      }));
    }

    function buildFilteredSortedRows(){
      const rows=[];
      for(const [agentId,rec] of Object.entries(agentsData)){
        const record=Object.assign({agent_id:agentId},rec);
        if(!recordMatchesFilters(record))continue;
        rows.push({agentId,record,html:buildRowHtml(record)});
      }
      if(sortState.key){
        rows.sort((a,b)=>{
          const A=a.record[sortState.key],B=b.record[sortState.key];
          if(A==null||B==null) return A==null ? -1*sortState.dir : 1*sortState.dir;
          return (typeof A === 'number' ? (A-B) : String(A).toLowerCase().localeCompare(String(B).toLowerCase())) * sortState.dir;
        });
      }
      return rows;
    }

    function buildRowHtml(rec){
        const values = columns.map(k => {
            let v = rec[k];
            if(/time|seen|until|timestamp/i.test(k) && v !== 0 && v !== 1 && v !== "0" && v !== "1") v = formatTime(v);
            if(k === 'stale') return v === true ? `<span class="stale-true">True</span>` : `<span class="bool-dark">False</span>`;
            if(k === 'lastStatus' || k === 'executionAdmin') return v === false ? `<span class="false-red">False</span>` : `<span class="bool-dark">True</span>`;
            if(typeof v === 'boolean') return `<span class="bool-dark">${v}</span>`;
            if(k === 'pausedUntil') {
                if ((Number(v) === 0) || (Number(v) === 1)) return `<span class="bool-dark">False</span>`;
                return `<span class="stale-true">${v}</span>`;
            }
            return escapeHtml(String(v ?? ''));
        });
        const pausedUntil = Number(rec.pausedUntil || 0);
        const pauseBtn = `<button class="btn pause" data-action="pause" data-agent="${escapeHtml(rec.agent_id)}">Pause</button>`;
        const resumeDisabled = ((pausedUntil === 0) || (pausedUntil === 1)) ? 'disabled class="btn muted"' : 'class="btn resume"';
        const resumeBtn = `<button ${resumeDisabled} data-action="resume" data-agent="${escapeHtml(rec.agent_id)}">Resume</button>`;
        
        return `<tr><td>${pauseBtn}</td><td>${resumeBtn}</td>${values.map(v => `<td>${v}</td>`).join('')}</tr>`;
    }

    function toggleSort(key){if(sortState.key===key){sortState.dir=-sortState.dir;}else{sortState.key=key;sortState.dir=1;}renderTable();}
    function recordMatchesFilters(record){for(const [k,v] of Object.entries(filters)){if(!v)continue;if(!String(record[k]??'').toLowerCase().includes(v.toLowerCase()))return false;}return true;}
    function openPauseModal(agentId){activePauseAgent=agentId;modalAgentId.textContent=agentId;pauseSecondsInput.value=60;modal.style.display='flex';}
    function closePauseModal(){modal.style.display='none';activePauseAgent=null;}
    async function confirmPause(){const secs=Number(pauseSecondsInput.value);if(!Number.isInteger(secs)||secs<=0)return;try{await postJSON(ENDPOINTS.pause,{agent_id:activePauseAgent,seconds:secs});closePauseModal();await fetchAgents();}catch(err){alert('Failed: '+err.message);}}
    function escapeHtml(s){return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]));}
    function downloadJSON(){const filename='agents_'+new Date().toISOString()+'.json';const b=new Blob([JSON.stringify(agentsData,null,2)],{type:'application/json'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=filename;a.click();URL.revokeObjectURL(u);}

    tableEl.addEventListener('mousedown', e => {
      if (!e.target.classList.contains('resizer')) return;
      const th = e.target.parentElement;
      const key = th.getAttribute('data-key') || (th.cellIndex === 0 ? '_actions' : '_resume');
      const startX = e.pageX; const startWidth = th.offsetWidth;
      const move = (ev) => { columnWidths[key] = Math.max(startWidth + (ev.pageX - startX), 30); th.style.width = columnWidths[key] + 'px'; };
      const up = () => { document.removeEventListener('mousemove', move); document.removeEventListener('mouseup', up); };
      document.addEventListener('mousemove', move); document.addEventListener('mouseup', up);
    });

    tableEl.addEventListener('dblclick', e => {
      if (e.target.classList.contains('resizer')) {
        const key = e.target.parentElement.getAttribute('data-key') || (e.target.parentElement.cellIndex === 0 ? '_actions' : '_resume');
        calculateIdealWidths(key); renderTable();
      }
    });

    cancelPauseBtn.addEventListener('click',closePauseModal);
    confirmPauseBtn.addEventListener('click',confirmPause);
    refreshBtn.addEventListener('click',fetchAgents);
    downloadBtn.addEventListener('click',downloadJSON);
    fetchAgents();
    setInterval(fetchAgents,60000);
  </script>
</body>
</html>