<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Git Agent Dashboard</title>
<style>
/* CSS inherited from your design */
:root{
  --bg:#0b1220; --card:#0f1a2b; --muted:#a0b0c0; --text:#ffffff;
  --accent:#4aa3ff; --accent-2:#2e6fb6; --row-hover:#0e2a45;
  --border: rgba(255,255,255,0.04); --bool-dark:#888888; --danger:#ff6b6b;
  font-family: Inter, ui-sans-serif, system-ui, -apple-system, sans-serif;
}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg), #071020);color:var(--text)}
.container{max-width:100%;margin:14px auto;padding:20px}
header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
h1{margin:0;font-size:20px}
p.lead{margin:0;color:var(--muted);font-size:13px}
.card{background:var(--card);border-radius:12px;padding:14px;border:1px solid var(--border);box-shadow:0 6px 20px rgba(10,15,25,0.6)}
table{width:1px; min-width:100%; border-collapse:collapse; font-size:13px; table-layout: fixed;}
thead th{position:sticky;top:0;background:rgba(12,20,30,0.95);backdrop-filter:blur(4px);z-index:2;padding:8px 10px;text-align:left;color:var(--muted);border-bottom:1px solid var(--border); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}
.resizer { position: absolute; right: 0; top: 0; height: 100%; width: 5px; cursor: col-resize; z-index: 3; }
.resizer:hover { background: var(--accent); }
tbody td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.02);vertical-align:middle;color:var(--text); overflow: hidden; text-overflow: ellipsis; width: 1%;}
tbody tr:hover{background:var(--row-hover)}
.col-filter input{width:100%;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.02);color:var(--text); box-sizing: border-box;}
.btn{appearance:none;border:0;padding:8px 10px;border-radius:8px;background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#042033;font-weight:600;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)}
.toast{position:fixed;bottom:20px;right:20px;background:var(--accent);color:#042033;padding:12px 18px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.3);opacity:0;transition:opacity 0.3s ease;z-index:100}
.toast.show{opacity:1;}
.site-footer { background-color: #042033; text-align: center; padding: 15px 0; font-size: 0.9rem; color: #555; }
.diff-tag { 
  display: inline-block; 
  padding: 2px 6px; 
  border-radius: 4px; 
  font-size: 11px; 
  margin-right: 4px; 
  background: rgba(255,255,255,0.08);
  white-space: nowrap; /* Keeps the + and the number together */
}
.add { color: #2ecc71; } .mod { color: #f1c40f; } .del { color: var(--danger); }
</style>
</head>
<body>
<div class="container">
  <header>
    <div style="display:flex;flex-direction:column">
      <div style="display:flex;align-items:center;gap:10px">
        <img src="../static/favicon.ico" alt="Icon" style="width:40px;height:40px;">
        <h1>Git Repository Dashboard</h1>
        <a href="/" style="color:var(--accent);text-decoration:none;font-size:13px;margin-left:10px">Back to Home</a>
      </div>
      <p class="lead">Latest branch statistics across all agent repositories.</p>
    </div>
    <div style="margin-left:auto;display:flex;flex-direction:column;align-items:flex-end;gap:4px">
      <button id="refreshBtn" class="btn ghost">Refresh</button>
      <span id="lastUpdate" style="font-size: 11px; color: var(--muted);">Updating...</span>
    </div>
  </header>

  <section class="card">
    <div id="agentInfoHeader" style="display:none; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border);">
        <button onclick="exitHistoryMode()" class="btn ghost" style="margin-bottom:10px">‚Üê Back to Overview</button>
        <div style="display:flex; gap:20px; font-size:14px;">
            <span><strong>Agent:</strong> <span id="infoName"></span></span>
            <span><strong>Hostname:</strong> <span id="infoHost"></span></span>
            <span><strong>IP:</strong> <span id="infoIP"></span></span>
        </div>
    </div>
    <div id="tableWrap" style="overflow:auto; max-height:70vh">
        <table id="gitTable"></table>
    </div>
  </section>

  <section id="diffContainer" class="card" style="display:none; margin-top: 20px;">
    <h3 style="margin-top:0; font-size:16px;">Commit Diff (vs. Good Tip)</h3>
    <pre id="diffBox" style="background:#050a14; padding:15px; border-radius:8px; overflow:auto; max-height:500px; font-family:monospace; font-size:12px; white-space:pre-wrap;"></pre>
  </section>
</div>

<div id="toast" class="toast">Git data refreshed successfully</div>

<footer class="site-footer">
  <p>Made by the <a href="https://github.com/CCDC-RIT" style="color:var(--accent)">Rochester Institute of Technology Collegiate Cyber Defense Team</a></p>
</footer>

<script>
const ENDPOINT = '/list_git_overall';
let gitData = [], columns = [], filters = {}, sortState = {key:null, dir:1}, searchTimer;
let columnWidths = {};
let historyMode = false;
let selectedRepo = null;

function escapeHtml(s){ return s ? s.toString().replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])) : ''; }
function showToast(msg = "Success"){ 
    const t=document.getElementById('toast'); 
    t.innerText = msg;
    t.classList.add('show'); 
    setTimeout(()=>t.classList.remove('show'),3000); 
}

async function fetchGitStats(){
    if(historyMode) return;
    try {
        const res = await fetch(ENDPOINT, { method: 'POST', headers: {'Content-Type': 'application/json'} });
        gitData = await res.json();
        await verifyClientContext();
        columns = deriveColumns(gitData);
        if (Object.keys(columnWidths).length === 0) calculateWidths();
        renderTable();
        document.getElementById('lastUpdate').innerText = "Updated: " + new Date().toLocaleTimeString();
    } catch(err) { console.error(err); }
}

function deriveColumns(data) {
    if (!data || data.length === 0) return [];
    return ["select", ...Object.keys(data[0])];
}

function calculateWidths() {
    columns.forEach(col => {
        if (col === 'diffs') { columnWidths[col] = 110; return; }
        if (col === 'select') { columnWidths[col] = 70; return; }
        let maxLength = col.length;
        gitData.forEach(rec => {
            const len = String(rec[col] ?? '').length;
            if (len > maxLength) maxLength = len;
        });
        columnWidths[col] = Math.min(Math.ceil(maxLength * 8.5) + 25, 400);
    });
}

// --- HISTORY MODE FUNCTIONS ---
async function enterHistoryMode(rec) {
    historyMode = true;
    selectedRepo = rec.repo_name;
    document.getElementById('agentInfoHeader').style.display = 'block';
    document.getElementById('infoName').innerText = rec.agent_name;
    document.getElementById('infoHost').innerText = rec.hostname;
    document.getElementById('infoIP').innerText = rec.ip;
    
    const res = await fetch('/get_repo_history', { 
        method: 'POST', 
        headers: {'Content-Type': 'application/json'}, 
        body: JSON.stringify({repo_name: rec.repo_name}) 
    });
    const history = await res.json();
    renderHistoryTable(history);
}

function exitHistoryMode() {
    historyMode = false;
    selectedRepo = null;
    document.getElementById('agentInfoHeader').style.display = 'none';
    document.getElementById('diffContainer').style.display = 'none';
    fetchGitStats();
}

async function viewDiff(hash) {
    const res = await fetch('/get_commit_diff', { 
        method: 'POST', 
        headers: {'Content-Type': 'application/json'}, 
        body: JSON.stringify({repo_name: selectedRepo, hash: hash}) 
    });
    const data = await res.json();
    const box = document.getElementById('diffBox');
    box.innerHTML = data.diff.split('\n').map(line => {
        if(line.startsWith('+')) return `<span class="add">${escapeHtml(line)}</span>`;
        if(line.startsWith('-')) return `<span class="del">${escapeHtml(line)}</span>`;
        return escapeHtml(line);
    }).join('\n');
    document.getElementById('diffContainer').style.display = 'block';
    box.scrollTop = 0;
}

async function setGood(hash) {
    if(!confirm("Restore repository to this state? This will create a new commit on 'good' and sync 'bad' to match.")) return;
    const res = await fetch('/set_good_branch', { 
        method: 'POST', 
        headers: {'Content-Type': 'application/json'}, 
        body: JSON.stringify({repo_name: selectedRepo, hash: hash}) 
    });
    if(res.ok) { 
        showToast("System Restored & Synced"); 
        // Refresh
        enterHistoryMode({
            repo_name: selectedRepo, 
            agent_name: document.getElementById('infoName').innerText, 
            hostname: document.getElementById('infoHost').innerText, 
            ip: document.getElementById('infoIP').innerText
        }); 
    }
}

// --- RENDER LOGIC ---
async function editNote(hash, currentNote) {
    const newNote = prompt("Edit Commit Notes:", currentNote);
    // Ensure we don't save if user cancels
    if (newNote === null) return;
    
    try {
        const res = await fetch('/save_git_note', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({repo_name: selectedRepo, hash: hash, note: newNote})
        });
        
        if(res.ok) {
            showToast("Note Saved");
            // Re-fetch history to update the view with the new note immediately
            const historyRes = await fetch('/get_repo_history', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({repo_name: selectedRepo}) 
            });
            const history = await historyRes.json();
            renderHistoryTable(history);
        } else {
            const err = await res.json();
            alert("Error saving note: " + err.error);
        }
    } catch (e) { console.error("Note save failed", e); }
}

function renderHistoryTable(data) {
    const tableEl = document.getElementById('gitTable');
    const cols = ["actions", "branch", "time", "name", "notes", "files_changed"];
    
    let thead = `<thead><tr>${cols.map(c => `<th>${c.toUpperCase()}</th>`).join('')}</tr></thead>`;
    let tbody = data.map(commit => {
        const fileTags = commit.changes.map(c => {
            let cls = c.type === 'A' ? 'add' : (c.type === 'D' ? 'del' : 'mod');
            return `<span class="diff-tag ${cls}">${c.file}</span>`;
        }).join(' ');
        
        return `<tr>
            <td>
                <button class="btn ghost" style="padding:4px 8px; font-size:11px" onclick="viewDiff('${commit.hash}')">Diff</button>
                ${commit.branch !== 'good' ? `<button class="btn" style="padding:4px 8px; font-size:11px" onclick="setGood('${commit.hash}')">Restore</button>` : ''}
            </td>
            <td><b style="color:${commit.branch==='good'?'#2ecc71':(commit.branch==='bad'?'#ff6b6b':'#666')}">${commit.branch || 'history'}</b></td>
            <td>${commit.time}</td>
            <td>${escapeHtml(commit.name)}</td>
            <td>
                <div style="display:flex; flex-direction:column; gap:4px">
                    <span style="color:var(--muted); font-size:11px; white-space:pre-wrap;">${escapeHtml(commit.notes) || '...'}</span>
                    <button class="btn ghost" style="width:fit-content; padding:2px 6px; font-size:10px" onclick="editNote('${commit.hash}', \`${escapeHtml(commit.notes)}\`)">Edit</button>
                </div>
            </td>
            <td style="white-space:normal;">${fileTags}</td>
        </tr>`;
    }).join('');
    
    tableEl.innerHTML = thead + '<tbody>' + tbody + '</tbody>';
}

function renderTable(){
    if(historyMode) return;
    const tableEl = document.getElementById('gitTable');
    let thead = '<thead><tr>' + columns.map(k => {
        const w = columnWidths[k];
        return `<th style="width:${w}px">${k.toUpperCase()}<div class="resizer"></div></th>`;
    }).join('') + '</tr></thead>';

    let tbody = gitData.map(rec => {
        return '<tr>' + columns.map(k => {
            if(k === 'select') return `<td><button class="btn" onclick='enterHistoryMode(${JSON.stringify(rec)})'>Select</button></td>`;
            if(k === 'diffs') return `<td><span class="diff-tag add">+${rec[k].files_added}</span><span class="diff-tag mod">~${rec[k].files_modified}</span><span class="diff-tag del">-${rec[k].files_deleted}</span></td>`;
            if(k === 'branch') return `<td><b style="color:${rec[k]==='good'?'#2ecc71':'#ff6b6b'}">${rec[k]}</b></td>`;
            return `<td>${escapeHtml(rec[k])}</td>`;
        }).join('') + '</tr>';
    }).join('');
    
    tableEl.innerHTML = thead + '<tbody>' + tbody + '</tbody>';
}

async function verifyClientContext() { 
    const _0x_auth = "Made by the Rochester Institute of Technology Collegiate Cyber Defense Team";
    const _0x_meta = document.querySelector('.site-footer');
    if (!_0x_meta?.innerText.includes(_0x_auth)) throw new Error("Integrity violation");
}

document.getElementById('refreshBtn').onclick = fetchGitStats;
fetchGitStats();
setInterval(fetchGitStats, 90000);
</script>

</body>
</html>