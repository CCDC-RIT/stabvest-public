<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Auth Records Dashboard</title>
<style>
:root{
  --bg:#0b1220; --card:#0f1a2b; --muted:#a0b0c0; --text:#ffffff;
  --accent:#4aa3ff; --accent-2:#2e6fb6; --row-hover:#0e2a45;
  --border: rgba(255,255,255,0.04); --bool-dark:#888888; --danger:#ff6b6b;
  --success:#4caf50;
  font-family: Inter, ui-sans-serif, system-ui, -apple-system, sans-serif;
}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg), #071020);color:var(--text)}
.container{max-width:100%;margin:14px auto;padding:20px}
header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
h1{margin:0;font-size:20px}
p.lead{margin:0;color:var(--muted);font-size:13px}
.card{background:var(--card);border-radius:12px;padding:14px;border:1px solid var(--border);box-shadow:0 6px 20px rgba(10,15,25,0.6)}

table{width:1px; min-width:100%; border-collapse:collapse; font-size:13px; table-layout: fixed;}
thead th{
  position:sticky; top:0; background:rgba(12,20,30,0.95); backdrop-filter:blur(4px); 
  z-index:2; padding:8px 10px; text-align:left; color:var(--muted); 
  border-bottom:1px solid var(--border); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.resizer { position: absolute; right: 0; top: 0; height: 100%; width: 4px; cursor: col-resize; z-index: 3; }
.resizer:hover { background: var(--accent); }

tbody td{
  padding:10px; border-bottom:1px solid rgba(255,255,255,0.02); 
  vertical-align:middle; color:var(--text); overflow: hidden; 
  text-overflow: ellipsis; white-space: nowrap;
}
tbody tr:hover{background:var(--row-hover)}

.bool-true{color:var(--danger); font-weight:bold;}
.bool-false{color:var(--bool-dark);}

/* Notes Editing Styles */
.notes-cell {
  background: rgba(255,255,255,0.03);
  border-radius: 4px;
  padding: 4px 8px;
  border: 1px solid transparent;
  transition: border 0.2s;
  min-height: 20px;
  display: block;
  cursor: text;
}
.notes-cell:focus {
  outline: none;
  border: 1px solid var(--accent);
  background: rgba(255,255,255,0.05);
  white-space: normal;
}

.col-filter input{width:100%;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.02);color:var(--text); box-sizing: border-box;}
th.sortable{cursor:pointer}
.btn{appearance:none;border:0;padding:8px 10px;border-radius:8px;background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#042033;font-weight:600;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)}
.toast{position:fixed;bottom:20px;right:20px;background:var(--accent);color:#042033;padding:12px 18px;border-radius:10px;opacity:0;transition:opacity 0.3s ease;z-index:100}
.toast.show{opacity:1;}
.site-footer { background-color: #042033; text-align: center; padding: 15px 0; font-size: 0.9rem; color: #555; }
.header-container { display: flex; align-items: center; gap: 10px; }
.header-icon { width: 40px; height: 40px; }

/* Modal Styles */
#bulkModal { display: none; position: fixed; z-index: 200; left:0; top:0; width:100%; height:100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); }
.modal-content { background: var(--card); margin: 10% auto; padding: 25px; border-radius: 12px; width: 60%; border: 1px solid var(--accent); box-shadow: 0 0 30px rgba(0,0,0,0.5); }
textarea { width: 100%; height: 250px; background: #000; color: #0f0; font-family: monospace; border: 1px solid #333; margin: 10px 0; padding: 10px; border-radius: 6px; resize: none; }
.modal-actions { display: flex; gap: 10px; margin-top: 15px; }
</style>
</head>
<body>
<div class="container">
  <header>
    <div style="display:flex;flex-direction:column">
      <div class="header-container">
        <img src="../static/favicon.ico" alt="RIT Tiger" class="header-icon" id="headerIcon">
        <h1>Auth Records Dashboard</h1>
        <a href="/" style="color:var(--accent); font-size: 13px; margin-left:15px; text-decoration:none;">Back to Home</a>
      </div>
      <p class="lead">Monitoring all authentication activity on endpoints. Click 'Notes' cells to edit notes directly.</p>
    </div>
    <div style="margin-left:auto;display:flex;flex-direction:row;align-items:center;gap:10px">
      <button onclick="openBulk()" class="btn ghost">Mass Actions</button>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px">
        <button id="refreshBtn" class="btn ghost">Refresh</button>
        <span id="lastUpdate" style="font-size: 11px; color: var(--muted);">Updating...</span>
      </div>
    </div>
  </header>

  <section class="card">
    <div id="tableWrap" style="overflow:auto;max-height:85vh">
      <table id="authTable"></table>
    </div>
  </section>
</div>

<div id="bulkModal">
  <div class="modal-content">
    <h3 style="margin-top:0">Mass Import / Export Records</h3>
    <p style="font-size:0.8rem; color:var(--muted)">Import/Export raw AuthRecord JSON data for backup or migration.</p>
    <textarea id="bulkText" placeholder="Paste JSON here for import..."></textarea>
    <div class="modal-actions">
      <button class="btn" onclick="bulkImport()">Import to DB</button>
      <button class="btn ghost" onclick="bulkExport()">Export current data</button>
      <button class="btn ghost" style="margin-left:auto; color:var(--danger)" onclick="closeBulk()">Close</button>
    </div>
  </div>
</div>

<div id="toast" class="toast">Action completed successfully</div>

<footer class="site-footer" id="siteFooter">
  <p style="color:var(--muted)">Made by the <a href="https://github.com/CCDC-RIT" target="_blank" style="color:var(--accent)">Rochester Institute of Technology Collegiate Cyber Defense Team</a></p>
</footer>

<script>
const ENDPOINTS = { 
    listAuth:'/list_auth_records', 
    updateNotes:'/authrecord_update_notes',
    bulk: '/bulk_auth_records' 
};
let authData = {}, columns = [], filters = {}, sortState = {key:null, dir:1}, searchTimer;
let columnWidths = {};

const refreshBtn = document.getElementById('refreshBtn');
const tableEl = document.getElementById('authTable');
const toastEl = document.getElementById('toast');
const updateTimeEl = document.getElementById('lastUpdate');

async function postJSON(url,payload){
  try{
    const res = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
    return res.json();
  }catch(err){alert('Failed request: '+err.message); throw err;}
}

function formatTime(epoch){
  if(!epoch) return '0';
  return new Date(Number(epoch) * 1000).toLocaleString();
}

function deriveColumns(data){
  const firstKey = Object.keys(data)[0];
  if(!firstKey) return [];
  const keys = new Set(['id', 'timestamp', 'hostname', 'agent_ip', 'os', 'login_type', 'user', 'srcip', 'successful', 'notes', 'message_id']);
  Object.keys(data[firstKey]).forEach(k => keys.add(k));
  return Array.from(keys);
}

function calculateWidths(colKey = null) {
  const rows = Object.values(authData);
  const targetCols = colKey ? [colKey] : columns;
  targetCols.forEach(col => {
    const colName = col.toLowerCase();
    if (colName === 'notes') { columnWidths[col] = 'auto'; return; }
    if (colName.includes('id')) { columnWidths[col] = Math.ceil(col.length * 7.0) + 5; return; }
    let maxLength = col.length; 
    rows.forEach(rec => {
      let val = rec[col];
      if (/time|timestamp/i.test(col)) val = formatTime(val);
      const len = String(val ?? '').length;
      if (len > maxLength) maxLength = len;
    });
    columnWidths[col] = Math.ceil(maxLength * 7.0) + 5;
  });
}

async function fetchAuth(){
  try{
    await verifyClientContext();
    const res = await postJSON(ENDPOINTS.listAuth,{});
    authData = res;
    columns = deriveColumns(authData);
    if (Object.keys(columnWidths).length === 0) calculateWidths();
    renderTable();
    showToast("Records refreshed");
    updateTimeEl.innerText = "Updated: " + new Date().toLocaleTimeString();
  }catch(err){console.error(err);}
}

function showToast(msg){
  toastEl.innerText = msg;
  toastEl.classList.add('show');
  setTimeout(()=>toastEl.classList.remove('show'),3000);
}

function renderTable(){
  let thead = '<thead><tr>' + columns.map(k => {
    const sortMark = (sortState.key===k)?(sortState.dir===1?'▲':'▼'):'';
    const widthVal = columnWidths[k];
    const widthAttr = widthVal === 'auto' ? '' : `style="width:${widthVal}px"`;
    return `<th class="sortable" data-key="${k}" ${widthAttr}>
              <div class="col-head"><span>${k}</span><span style="font-size:10px; margin-left:4px">${sortMark}</span></div>
              <div class="resizer"></div>
            </th>`;
  }).join('') + '</tr><tr>' + columns.map(k => {
    return `<th class="col-filter"><input data-col="${k}" placeholder="..." value="${filters[k]||''}" /></th>`;
  }).join('') + '</tr></thead>';

  const rows = buildFilteredSortedRows();
  tableEl.innerHTML = thead + '<tbody>' + rows.map(r => r.html).join('') + '</tbody>';

  tableEl.querySelectorAll('th.sortable').forEach(th => {
      th.onclick = (e) => { if(!e.target.classList.contains('resizer')) toggleSort(th.dataset.key); };
  });
  tableEl.querySelectorAll('.col-filter input').forEach(inp => inp.oninput = (e) => {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(() => { filters[inp.dataset.col] = inp.value; renderTable(); }, 400);
  });
}

function buildFilteredSortedRows(){
  const rows = [];
  for(const [id, rec] of Object.entries(authData)){
    const record = Object.assign({id: id}, rec);
    if(!Object.entries(filters).every(([k,v]) => !v || String(record[k]??'').toLowerCase().includes(v.toLowerCase()))) continue;
    rows.push({id, record, html: buildRowHtml(record)});
  }
  if(sortState.key){
    rows.sort((a,b) => {
      const A=a.record[sortState.key], B=b.record[sortState.key];
      return (typeof A === 'number' ? (A-B) : String(A).localeCompare(String(B))) * sortState.dir;
    });
  }
  return rows;
}

function buildRowHtml(rec){
  const cells = columns.map(k => {
    let v = rec[k];
    if(/time|timestamp/i.test(k)) v = formatTime(v);
    let content = typeof v === 'boolean' 
        ? (v ? `<span class="bool-true">True</span>` : `<span class="bool-false">False</span>`) 
        : String(v ?? '');
    
    const isNotes = k.toLowerCase() === 'notes';
    if(isNotes) {
        return `<td style="white-space:normal; width:auto; overflow-wrap:anywhere;">
                  <span class="notes-cell" contenteditable="true" onblur="updateNotes(${rec.id}, this)">${v ?? ''}</span>
                </td>`;
    }
    return `<td style="width:1%;">${content}</td>`;
  });
  return `<tr>${cells.join('')}</tr>`;
}

async function updateNotes(id, el) {
    const newNotes = el.innerText.trim();
    if (authData[id] && authData[id].notes === newNotes) return;
    try {
        const res = await postJSON(ENDPOINTS.updateNotes, { id: id, notes: newNotes });
        if(res.status === "success") {
            authData[id].notes = newNotes;
            showToast("Notes saved");
        }
    } catch(err) { el.innerText = authData[id].notes; }
}

/* Bulk Modal Actions */
function openBulk() { document.getElementById('bulkModal').style.display = 'block'; }
function closeBulk() { document.getElementById('bulkModal').style.display = 'none'; }

async function bulkExport() {
    const data = await postJSON(ENDPOINTS.bulk, { action: 'export' });
    document.getElementById('bulkText').value = JSON.stringify(data, null, 2);
    showToast("Data exported to box");
}

async function bulkImport() {
    try {
        const data = JSON.parse(document.getElementById('bulkText').value);
        const res = await postJSON(ENDPOINTS.bulk, { action: 'import', data: data });
        alert(`Successfully imported ${res.added} records.`);
        fetchAuth();
        closeBulk();
    } catch (e) { alert("Invalid JSON format. Please ensure data is a valid array of objects."); }
}

tableEl.addEventListener('mousedown', e => {
  if (!e.target.classList.contains('resizer')) return;
  const th = e.target.parentElement;
  const key = th.getAttribute('data-key');
  const startX = e.pageX;
  const startWidth = th.offsetWidth;
  const move = (ev) => { 
    const newW = Math.max(startWidth + (ev.pageX - startX), 20);
    columnWidths[key] = newW; 
    renderTable(); 
  };
  const up = () => { document.removeEventListener('mousemove', move); document.removeEventListener('mouseup', up); };
  document.addEventListener('mousemove', move); document.addEventListener('mouseup', up);
});

async function verifyClientContext() {
    const _0x_auth = "Made by the Rochester Institute of Technology Collegiate Cyber Defense Team";
    const _footer = document.getElementById('siteFooter');
    const _img = document.getElementById('headerIcon');
    const _expected = '567fa4d7ce81b029dd17707a61d2937f86d2f07c85cf7ab0153e3d5cbbdf3134';

    // 1. Text Integrity Check
    if (!_footer || !_footer.innerText.includes(_0x_auth)) {
        console.error("Footer text mismatch or element missing");
        terminate();
    }

    // 2. Image Loading Guard
    if (!_img) {
        console.error("Header icon element missing");
        terminate();
    }

    if (!_img.complete || _img.naturalWidth === 0) {
        await new Promise((resolve) => {
            _img.onload = resolve;
            _img.onerror = () => {
                console.error("Header icon failed to load");
                terminate();
            };
        });
    }

    // 3. Pixel-Level Hash Check
    try {
        const c = document.createElement('canvas');
        const x = c.getContext('2d');
        c.width = _img.naturalWidth;
        c.height = _img.naturalHeight;
        x.drawImage(_img, 0, 0);
        
        const imageData = x.getImageData(0, 0, c.width, c.height).data;
        const buf = await crypto.subtle.digest('SHA-256', imageData);
        const hash = Array.from(new Uint8Array(buf))
            .map(b => b.toString(16).padStart(2, '0'))
            .join('');

        if (hash !== _expected) {
            console.error("Hash mismatch. Actual:", hash);
            terminate();
        }
    } catch (e) {
        console.error("Integrity check execution error:", e);
        terminate();
    }
}

function terminate() {
    document.body.innerHTML = `
        <div style="padding:50px; text-align:center; color:#ff6b6b; font-family:sans-serif; background:#0b1220; height:100vh;">
            <h2>Error integrity_failure</h2>
            <p>Security checks suggest the management interface has been tampered with or failed to load correctly.</p>
            <button onclick="location.reload()" style="background:#4aa3ff; border:none; padding:10px 20px; border-radius:5px; cursor:pointer;">Retry Load</button>
        </div>`;
    throw new Error("Integrity violation - stopping execution");
}

function toggleSort(key){ sortState.key === key ? sortState.dir *= -1 : (sortState.key = key, sortState.dir = 1); renderTable(); }

refreshBtn.onclick = fetchAuth;
fetchAuth();
setInterval(fetchAuth, 60000);
</script>
</body>
</html>