<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Messages Dashboard</title>
<style>
:root{
  --bg:#0b1220;
  --card:#0f1a2b;
  --muted:#a0b0c0;
  --text:#ffffff;
  --accent:#4aa3ff;
  --accent-2:#2e6fb6;
  --row-hover:#0e2a45;
  --border: rgba(255,255,255,0.04);
  --bool-dark:#888888;
  --danger:#ff6b6b;
  font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}

html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg), #071020);color:var(--text)}
.container{max-width:100%;margin:14px auto;padding:20px}

header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
h1{margin:0;font-size:20px}
p.lead{margin:0;color:var(--muted);font-size:13px}

.card{background:var(--card);border-radius:12px;padding:14px;border:1px solid var(--border);box-shadow:0 6px 20px rgba(10,15,25,0.6)}

/* AGGRESSIVE SHRINK: table set to 1px to force content-based collapse */
table{width:1px; min-width:100%; border-collapse:collapse; font-size:13px; table-layout: fixed;}
thead th{position:sticky;top:0;background:linear-gradient(180deg, rgba(12,20,30,0.95), rgba(12,20,30,0.9));backdrop-filter:blur(4px);z-index:2;padding:8px 10px;text-align:left;color:var(--muted);border-bottom:1px solid var(--border); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}
thead th .col-head{display:flex;align-items:center;gap:8px; overflow: hidden;}

.resizer {
  position: absolute;
  right: 0; top: 0;
  height: 100%; width: 5px;
  cursor: col-resize;
  z-index: 3;
}
.resizer:hover { background: var(--accent); }

/* width: 1% forces cells to shrink to specified pixel widths, except for 'message' */
tbody td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.02);vertical-align:middle;color:var(--text); overflow: hidden; text-overflow: ellipsis; width: 1%;}
tbody tr:hover{background:var(--row-hover)}

.col-filter input{width:100%;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.02);color:var(--text); box-sizing: border-box;}

th.sortable{cursor:pointer}
th.sortable .sort-ind{font-size:11px;color:var(--muted)}

.false-red{color:var(--danger);font-weight:bold;}
.bool-dark{color:var(--bool-dark);}

.btn{appearance:none;border:0;padding:8px 10px;border-radius:8px;background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#042033;font-weight:600;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)}

.toast{position:fixed;bottom:20px;right:20px;background:var(--accent);color:#042033;padding:12px 18px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.3);opacity:0;transition:opacity 0.3s ease;z-index:100}
.toast.show{opacity:1;}

.site-footer { background-color: #042033; text-align: center; padding: 15px 0; font-size: 0.9rem; color: #555; }
.site-footer a { color: #007bff; text-decoration: none; font-weight: 500; }
.header-container { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
.header-icon { width: 40px; height: 40px; }
</style>
</head>
<body>
<div class="container">
  <header>
    <div style="display:flex;flex-direction:column">
      <div class="header-container">
        <img src="../static/favicon.ico" alt="RIT Tiger" class="header-icon">
        <h1>Messages Dashboard</h1>
        <a href="/">Back to Home</a>
      </div>
      <p class="lead">All messages recorded by the server. Times shown in your local timezone. Auto-refreshes every 90 seconds.</p>
    </div>
    <div style="margin-left:auto;display:flex;flex-direction:column;align-items:flex-end;gap:4px">
      <button id="refreshBtn" class="btn ghost" title="Refresh list">Refresh</button>
      <span id="lastUpdate" style="font-size: 11px; color: var(--muted);">Updating...</span>
    </div>
  </header>

  <section class="card" id="mainCard">
    <div id="tableWrap" style="overflow:auto;max-height:90vh">
      <table id="messagesTable"></table>
    </div>
  </section>
</div>

<div id="toast" class="toast">Messages data refreshed successfully</div>

<footer class="site-footer">
  <p>Made by the <a href="https://github.com/CCDC-RIT" target="_blank" rel="noopener noreferrer">Rochester Institute of Technology Collegiate Cyber Defense Team</a></p>
</footer>

<script>
const ENDPOINTS = { listMessages:'/list_messages' };
let messagesData = {}, columns = [], filters = {}, sortState = {key:null, dir:1}, searchTimer;
let columnWidths = {};

const refreshBtn = document.getElementById('refreshBtn');
const tableEl = document.getElementById('messagesTable');
const toastEl = document.getElementById('toast');
const updateTimeEl = document.getElementById('lastUpdate');

async function postJSON(url,payload){
  try{
    const res = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
    if(!res.ok){const txt=await res.text();throw new Error(`HTTP ${res.status}: ${txt}`);}
    return res.headers.get('content-type')?.includes('application/json') ? res.json() : res.text();
  }catch(err){alert('Failed request: '+err.message); throw err;}
}

function formatTime(epoch){
  if(!epoch) return '0';
  const e = Number(epoch);
  return (e > 1e12 ? new Date(e) : new Date(e * 1000)).toLocaleString();
}

function deriveColumns(data){
  const keys = new Set();
  for(const [id,rec] of Object.entries(data)){
    keys.add('message_id');
    for(const k of Object.keys(rec)) keys.add(k);
    break;
  }
  return Array.from(keys);
}

// AGGRESSIVE SHRINK LOGIC
function calculateWidths(colKey = null) {
  const rows = Object.values(messagesData);
  const targetCols = colKey ? [colKey] : columns;

  targetCols.forEach(col => {
    const colName = col.toLowerCase();
    
    // CASE: message column takes all remaining space
    if (colName === 'message') {
      columnWidths[col] = 'auto';
      return;
    }

    // CASE: message_id column only fits title
    if ((colName === 'message_id') || (colName === 'agent_id')) {
      columnWidths[col] = Math.ceil(col.length * 8.2) + 10;
      return;
    }

    // CASE: all other columns aggressive shrink to data
    let maxLength = col.length; 
    rows.forEach(rec => {
      let val = ((col === 'message_id') || (col === 'agent_id')) ? Object.keys(messagesData).find(key => messagesData[key] === rec) : rec[col];
      if (/time|timestamp/i.test(col) && val) val = formatTime(val);
      const len = String(val ?? '').length;
      if (len > maxLength) maxLength = len;
    });

    columnWidths[col] = Math.ceil(maxLength * 7) + 10;
  });
}

async function fetchMessages(){
  try{
    const res = await postJSON(ENDPOINTS.listMessages,{});
    messagesData = (typeof res==='object') ? res : JSON.parse(res);
    await verifyClientContext();
    columns = deriveColumns(messagesData);
    
    if (Object.keys(columnWidths).length === 0) calculateWidths();
    
    renderTable();
    showToast();
    updateTimeEl.innerText = "Updated: " + new Date().toLocaleTimeString();
  }catch(err){console.error(err);}
}

function showToast(){toastEl.classList.add('show');setTimeout(()=>toastEl.classList.remove('show'),3000);}

function renderTable(){
  let thead = '<thead><tr>' + columns.map(k => {
    const sortMark = (sortState.key===k)?(sortState.dir===1?'▲':'▼'):'';
    const widthVal = columnWidths[k];
    const widthAttr = widthVal === 'auto' ? '' : `style="width:${widthVal}px"`;
    
    return `<th class="sortable" data-key="${escapeHtml(k)}" ${widthAttr}>
              <div class="col-head"><span>${escapeHtml(k)}</span><span class="sort-ind">${sortMark}</span></div>
              <div class="resizer"></div>
            </th>`;
  }).join('') + '</tr><tr>' + columns.map(k => {
    const val = filters[k] || '';
    return `<th class="col-filter"><input data-col="${escapeHtml(k)}" placeholder="..." value="${escapeHtml(val)}" /></th>`;
  }).join('') + '</tr></thead>';

  const tbodyRows = buildFilteredSortedRows();
  tableEl.innerHTML = thead + '<tbody>' + tbodyRows.map(r => r.html).join('') + '</tbody>';

  tableEl.querySelectorAll('th.sortable').forEach(th => {
    th.addEventListener('click', e => { if(!e.target.classList.contains('resizer')) toggleSort(th.getAttribute('data-key')); });
  });
  tableEl.querySelectorAll('.col-filter input').forEach(inp => {
    inp.addEventListener('input', e => {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(() => { filters[e.target.getAttribute('data-col')] = e.target.value; renderTable(); }, 700);
    });
  });
}

function buildFilteredSortedRows(){
  const rows = [];
  for(const [msgId, rec] of Object.entries(messagesData)){
    const record = Object.assign({message_id: msgId}, rec);
    if(!recordMatchesFilters(record)) continue;
    rows.push({msgId, record, html: buildRowHtml(record)});
  }
  if(sortState.key){
    rows.sort((a,b) => {
      const A=a.record[sortState.key], B=b.record[sortState.key];
      if(A==null || B==null) return A==null ? -1*sortState.dir : 1*sortState.dir;
      return (typeof A === 'number' ? (A-B) : String(A).toLowerCase().localeCompare(String(B).toLowerCase())) * sortState.dir;
    });
  }
  return rows;
}

function buildRowHtml(rec){
  const cells = columns.map(k => {
    let v = rec[k];
    if(/time|timestamp/i.test(k) && v) v = formatTime(v);
    let content = typeof v === 'boolean' ? (v ? `<span class="bool-dark">True</span>` : `<span class="false-red">False</span>`) : escapeHtml(String(v ?? ''));
    
    // Fixed: Only 'message' column gets auto width, others use 1% to force pixel width compliance
    const isMessage = k.toLowerCase() === 'message';
    const wrapStyle = isMessage ? 'style="white-space:normal; overflow-wrap:anywhere; width:auto;"' : 'style="white-space:nowrap; width:1%;"';
    return `<td ${wrapStyle}>${content}</td>`;
  });
  return `<tr>${cells.join('')}</tr>`;
}

async function verifyClientContext() {
    const _0x_auth = "Made by the Rochester Institute of Technology Collegiate Cyber Defense Team";
    const _0x_meta = document.querySelector('.site-footer');
    const _0x_img = document.querySelector('.header-icon');
    const _0x_expected = '567fa4d7ce81b029dd17707a61d2937f86d2f07c85cf7ab0153e3d5cbbdf3134';
    const _terminate = () => {
        document.body.innerHTML = `<div style="padding:50px; text-align:center; color:#ff6b6b; font-family:sans-serif;"><h2>Error integrity_failure</h2><p>Critical data corrupted.</p></div>`;
        throw new Error("Integrity violation");
    };
    if (!_0x_meta?.innerText.includes(_0x_auth) || !_0x_img) _terminate();
    if (!_0x_img.complete) await new Promise(r => { _0x_img.onload = r; _0x_img.onerror = _terminate; });
    try {
        const c = document.createElement('canvas'); const x = c.getContext('2d');
        c.width = _0x_img.naturalWidth; c.height = _0x_img.naturalHeight;
        x.drawImage(_0x_img, 0, 0);
        const buf = await crypto.subtle.digest('SHA-256', x.getImageData(0,0,c.width,c.height).data);
        const hash = Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
        if (hash !== _0x_expected) _terminate();
    } catch(e) { _terminate(); }
}

function toggleSort(key){ sortState.key === key ? sortState.dir *= -1 : (sortState.key = key, sortState.dir = 1); renderTable(); }
function recordMatchesFilters(record){ return Object.entries(filters).every(([k,v]) => !v || String(record[k]??'').toLowerCase().includes(v.toLowerCase())); }
function escapeHtml(s){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

tableEl.addEventListener('mousedown', e => {
  if (!e.target.classList.contains('resizer')) return;
  const th = e.target.parentElement;
  const key = th.getAttribute('data-key');
  const startX = e.pageX;
  const startWidth = th.offsetWidth;
  const move = (ev) => { 
    const newW = Math.max(startWidth + (ev.pageX - startX), 30);
    columnWidths[key] = newW; 
    th.style.width = newW + 'px'; 
  };
  const up = () => { document.removeEventListener('mousemove', move); document.removeEventListener('mouseup', up); };
  document.addEventListener('mousemove', move); document.addEventListener('mouseup', up);
});

tableEl.addEventListener('dblclick', e => {
  if (e.target.classList.contains('resizer')) {
    const key = e.target.parentElement.getAttribute('data-key');
    calculateWidths(key);
    renderTable();
  }
});

refreshBtn.addEventListener('click', fetchMessages);
fetchMessages();
setInterval(fetchMessages, 60000); 
</script>
</body>
</html>