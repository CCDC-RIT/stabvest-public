<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Auth Configuration Management Pro</title>
<style>
  :root {
    --bg: #0b1220; --card: #0f1a2b; --text: #ffffff; --muted: #a0b0c0;
    --accent: #4aa3ff; --accent-2: #2e6fb6; --danger: #ff6b6b; --success: #4caf50;
    --border: rgba(255,255,255,0.04);
  }
  body { font-family: Inter, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; }
  header { background: #1f1f1f; color: #fff; padding: 1rem; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); }
  main { padding: 1rem; display: flex; flex-direction: column; gap: 1rem; }
  .top-row { display: flex; gap: 1rem; flex-wrap: wrap; }
  section { flex: 1; display: flex; flex-direction: column; min-width: 400px; }
  
  h2 { margin: 0 0 1rem 0; font-size: 1.2rem; border-left: 4px solid var(--accent); padding-left: 10px; }
  .card { background: var(--card); border-radius: 8px; padding: 0.75rem; margin-bottom: 0.75rem; border: 1px solid var(--border); box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
  
  /* Policy Toggles */
  .policy-box { display: flex; gap: 20px; background: rgba(74, 163, 255, 0.05); border: 1px solid rgba(74, 163, 255, 0.2); }
  .toggle-container { display: flex; align-items: center; gap: 10px; }
  .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 20px; }
  .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
  input:checked + .slider { background-color: var(--accent); }
  input:checked + .slider:before { transform: translateX(20px); }

  .row { display: flex; gap: 0.5rem; align-items: center; }
  .row > * { flex: 1; }

  .filter-bar { background: rgba(255,255,255,0.05); margin-bottom: 10px; padding: 8px; border-radius: 6px; display: flex; gap: 10px; }
  .filter-bar input { background: transparent; border: 1px solid var(--border); color: white; padding: 5px; border-radius: 4px; flex: 2; }
  
  .disposition-tag { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; cursor: pointer; text-align: center; user-select: none; }
  .LEGITIMATE { background: var(--success); color: #fff; }
  .MALICIOUS { background: var(--danger); color: #fff; }

  input, select, button { padding: 0.6rem; border-radius: 6px; border: none; background: #2a2a2a; color: var(--text); }
  button { cursor: pointer; background: linear-gradient(180deg, var(--accent), var(--accent-2)); color: #042033; font-weight: 700; }
  .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text); }
  .btn-delete { color: var(--danger); background: transparent; border: none; font-size: 1.2rem; cursor: pointer; }

  .site-footer { background-color: #042033; text-align: center; padding: 15px 0; font-size: 0.85rem; color: #555; }
  .site-footer a { color: var(--accent); text-decoration: none; }
  .header-icon { width: 35px; height: 35px; margin-right: 10px; }
  
  #bulkModal { display: none; position: fixed; z-index: 100; left:0; top:0; width:100%; height:100%; background: rgba(0,0,0,0.8); }
  .modal-content { background: var(--card); margin: 10% auto; padding: 20px; border-radius: 10px; width: 60%; border: 1px solid var(--accent); }
  textarea { width: 100%; height: 200px; background: #000; color: #0f0; font-family: monospace; border: 1px solid #333; margin: 10px 0; }
</style>
</head>
<body>

<header>
  <div style="display:flex; align-items:center;">
    <img src="../static/favicon.ico" alt="Tiger" class="header-icon" id="headerIcon">
    <h1 style="margin:0; font-size:1.4rem;">Auth Config Management</h1>
    <a href="/" style="margin-left:20px; color:var(--muted); font-size:0.8rem;">[Back to Home]</a>
  </div>
  <div style="text-align:right">
    <button class="btn-ghost" onclick="openBulk()">Mass Actions</button>
    <button onclick="refreshConfig()">Refresh</button>
    <div id="lastUpdate" style="font-size: 10px; color: var(--muted); margin-top:5px;">Never updated</div>
  </div>
</header>

<main>
  <section>
    <h2>Agent Policy Settings</h2>
    <div class="card policy-box">
        <div class="toggle-container">
            <span>Create Incident Mode:</span>
            <label class="switch">
            <input type="checkbox" id="createIncidentToggle" onchange="updatePolicy('create_incident', this.checked)">
            <span class="slider"></span>
            </label>
            <small style="color:var(--muted)">True = Create incs if alert criteria met<br>False = Do not create incidents, only log</small>
        </div>
        <div class="toggle-container">
            <span>Log Attempt Mode:</span>
            <label class="switch">
            <input type="checkbox" id="logAttemptSuccessfulToggle" onchange="updatePolicy('log_attempt_successful', this.checked)">
            <span class="slider"></span>
            </label>
            <small style="color:var(--muted)">True = Log attempt only if login was successful<br>False = Log attempt regardless of state</small>
        </div>
      <div class="toggle-container">
        <span>IP Strict Mode:</span>
        <label class="switch">
          <input type="checkbox" id="strictIpToggle" onchange="updatePolicy('strict_ip', this.checked)">
          <span class="slider"></span>
        </label>
        <small style="color:var(--muted)">True = Alert on all except legit IPs<br>False = Alert if matched malicious IP</small>
      </div>
      <div class="toggle-container">
        <span>User Strict Mode:</span>
        <label class="switch">
          <input type="checkbox" id="strictUserToggle" onchange="updatePolicy('strict_user', this.checked)">
          <span class="slider"></span>
        </label>
        <small style="color:var(--muted)">True = Alert on all except legit Users<br>False = Alert if matched malicious user</small>
      </div>
    </div>
  </section>

  <div class="top-row">
    <section>
      <h2>IP Addresses</h2>
      <div class="card">
        <div class="row">
          <input type="text" id="newIpValue" placeholder="192.168.1.1">
          <select id="newIpDisp"><option value="LEGITIMATE">LEGITIMATE</option><option value="MALICIOUS">MALICIOUS</option></select>
          <button onclick="addEntry('IP')">Add</button>
        </div>
      </div>
      <div class="filter-bar">
        <input type="text" id="ipFilter" placeholder="Search IP..." oninput="renderLists()">
        <select id="ipStatusFilter" onchange="renderLists()">
          <option value="">All Status</option>
          <option value="LEGITIMATE">LEGITIMATE</option>
          <option value="MALICIOUS">MALICIOUS</option>
        </select>
      </div>
      <div id="ipList"></div>
    </section>

    <section>
      <h2>Usernames</h2>
      <div class="card">
        <div class="row">
          <input type="text" id="newUserValue" placeholder="root">
          <select id="newUserDisp"><option value="LEGITIMATE">LEGITIMATE</option><option value="MALICIOUS">MALICIOUS</option></select>
          <button onclick="addEntry('USER')">Add</button>
        </div>
      </div>
      <div class="filter-bar">
        <input type="text" id="userFilter" placeholder="Search user..." oninput="renderLists()">
        <select id="userStatusFilter" onchange="renderLists()">
          <option value="">All Status</option>
          <option value="LEGITIMATE">LEGITIMATE</option>
          <option value="MALICIOUS">MALICIOUS</option>
        </select>
      </div>
      <div id="userList"></div>
    </section>
  </div>
</main>

<div id="bulkModal">
  <div class="modal-content">
    <h3>Mass Import / Export (JSON)</h3>
    <textarea id="bulkText" placeholder="Paste JSON here for import..."></textarea>
    <div class="row">
      <button onclick="bulkImport()">Import from Box</button>
      <button onclick="bulkExport()">Export current to Box</button>
      <button class="btn-ghost" onclick="closeBulk()">Close</button>
    </div>
  </div>
</div>

<footer class="site-footer" id="siteFooter">
  <p>Made by the <a href="https://github.com/CCDC-RIT" target="_blank">Rochester Institute of Technology Collegiate Cyber Defense Team</a></p>
</footer>

<script>
let masterData = [];

async function apiCall(url, payload) {
    const res = await fetch(url, {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    });
    return res.json();
}

async function refreshConfig() {
    try {
        await verifyClientContext();
        // Fetch indicators
        masterData = await apiCall('/list_authconfig', {});
        // Fetch global policies
        const policies = await apiCall('/list_authconfigglobal', {});
        
        document.getElementById('createIncidentToggle').checked = !!policies.create_incident;
        document.getElementById('logAttemptSuccessfulToggle').checked = !!policies.log_attempt_successful;
        document.getElementById('strictIpToggle').checked = !!policies.strict_ip;
        document.getElementById('strictUserToggle').checked = !!policies.strict_user;
        
        renderLists();
        document.getElementById('lastUpdate').innerText = "Last Success: " + new Date().toLocaleTimeString();
    } catch (e) { console.error(e); }
}

async function updatePolicy(key, value) {
    await apiCall('/update_authconfigglobal', { key, value });
    console.log(`Policy ${key} updated to ${value}`);
}

function renderLists() {
    const containers = { IP: document.getElementById('ipList'), USER: document.getElementById('userList') };
    const filters = {
        IP: { text: document.getElementById('ipFilter').value.toLowerCase(), status: document.getElementById('ipStatusFilter').value },
        USER: { text: document.getElementById('userFilter').value.toLowerCase(), status: document.getElementById('userStatusFilter').value }
    };

    containers.IP.innerHTML = ''; containers.USER.innerHTML = '';
    const sortedData = [...masterData].sort((a,b) => a.entity_value.localeCompare(b.entity_value));

    sortedData.forEach(entry => {
        const type = entry.entity_type;
        const textMatch = entry.entity_value.toLowerCase().includes(filters[type].text);
        const statusMatch = !filters[type].status || entry.disposition === filters[type].status;

        if (textMatch && statusMatch) {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="row">
                    <strong style="font-family:monospace;">${entry.entity_value}</strong>
                    <span class="disposition-tag ${entry.disposition}" onclick="toggleStatus(${entry.id})">${entry.disposition}</span>
                    <button class="btn-delete" onclick="deleteEntry(${entry.id})">Ã—</button>
                </div>`;
            containers[type].appendChild(card);
        }
    });
}

async function addEntry(type) {
    const val = document.getElementById(type === 'IP' ? 'newIpValue' : 'newUserValue').value.trim();
    const disp = document.getElementById(type === 'IP' ? 'newIpDisp' : 'newUserDisp').value;
    if (!val) return;
    await apiCall('/add_authconfig', { entity_value: val, entity_type: type, disposition: disp });
    document.getElementById(type === 'IP' ? 'newIpValue' : 'newUserValue').value = '';
    refreshConfig();
}

async function toggleStatus(id) {
    await apiCall('/update_authconfig_status', { id });
    refreshConfig();
}

async function deleteEntry(id) {
    if (confirm("Delete?")) { await apiCall('/delete_authconfig', { id }); refreshConfig(); }
}

function openBulk() { document.getElementById('bulkModal').style.display = 'block'; }
function closeBulk() { document.getElementById('bulkModal').style.display = 'none'; }

async function bulkExport() {
    const data = await apiCall('/bulk_authconfig', { action: 'export' });
    document.getElementById('bulkText').value = JSON.stringify(data, null, 2);
}

async function bulkImport() {
    try {
        const data = JSON.parse(document.getElementById('bulkText').value);
        await apiCall('/bulk_authconfig', { action: 'import', data: data });
        refreshConfig();
        closeBulk();
    } catch (e) { alert("Invalid JSON"); }
}

async function verifyClientContext() {
    const _0x_auth = "Made by the Rochester Institute of Technology Collegiate Cyber Defense Team";
    const _footer = document.getElementById('siteFooter');
    const _img = document.getElementById('headerIcon');
    const _expected = '567fa4d7ce81b029dd17707a61d2937f86d2f07c85cf7ab0153e3d5cbbdf3134';
    if (!_footer || !_footer.innerText.includes(_0x_auth)) terminate();
    if (!_img.complete) await new Promise(r => _img.onload = r);
    const c = document.createElement('canvas'); const x = c.getContext('2d');
    c.width = _img.naturalWidth; c.height = _img.naturalHeight;
    x.drawImage(_img, 0, 0);
    const buf = await crypto.subtle.digest('SHA-256', x.getImageData(0,0,c.width,c.height).data);
    const actual = Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
    if (actual !== _expected) terminate();
}

function terminate() { document.body.innerHTML = "Integrity Failure"; throw new Error(); }

refreshConfig();
setInterval(refreshConfig, 90000);
</script>
</body>
</html>